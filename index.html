<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ¸…ç„¶çš„æœªæ¥æ—¥å†</title>
  <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-screen-web@1.1.0/style.min.css" rel="stylesheet" />
  <style>
    /* å…¨å±€å­—ä½“ç»Ÿä¸€ */
    body {
      margin: 0;
      background: url("IMG_8914.JPG") no-repeat center center fixed;
      background-size: cover;
      color: #1d2b41;
      overflow-x: hidden;
      font-family: 'LXGW WenKai Screen', 'Patrick Hand', sans-serif;
    }
    body * {
      font-family: 'LXGW WenKai Screen', 'Patrick Hand', sans-serif;
    }

    header {
      background: rgba(255, 255, 255, 0.5);
      color: #1d2b41;
      text-align: center;
      padding: 1rem;
      font-size: 1.5rem;
      font-weight: bold;
      backdrop-filter: blur(5px);
    }
    header button {
      margin-left: 1rem;
      vertical-align: middle;
    }

    .nav {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1rem;
      margin: 1rem;
      flex-wrap: wrap;
      background: rgba(255, 255, 255, 0.5);
      padding: 0.5rem;
      border-radius: 8px;
      backdrop-filter: blur(5px);
    }

    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
      padding: 1rem;
      background: rgba(255,255,255,0.4);
      border-radius: 12px;
      backdrop-filter: blur(4px);
    }

    .weekday {
      background: rgba(255,255,255,0.6);
      padding: 0.5rem;
      text-align: center;
      font-weight: bold;
    }

    .day {
      background: rgba(255, 255, 255, 0.8);
      border-radius: 6px;
      padding: 0.5rem;
      text-align: center;
      cursor: pointer;
      position: relative;
      font-weight: bold;
      transition: box-shadow 0.2s ease;
    }
    .day:hover,
    .day.selected {
      box-shadow: 0 0 0 2px #497de5 inset;
    }

    /* å°åœ†ç‚¹ï¼šæœ‰ç•™è¨€çš„æ—¥å­ */
    .day::after {
      content: "";
      width: 6px;
      height: 6px;
      background: #497de5;
      border-radius: 50%;
      position: absolute;
      bottom: 6px;
      left: 50%;
      transform: translateX(-50%);
      display: none;
    }
    .day.has-note::after {
      display: block;
    }

    /* æ—¥æœŸæ•°å­—å•ç‹¬ä¸€ä¸ªå±‚ï¼Œä¿è¯åœ¨å›¾æ ‡ä¸Šé¢ */
    .day-number {
      position: relative;
      z-index: 1;
    }

    /* ç”Ÿæ—¥ï¼šæ·±ä¸€ç‚¹è“è‰²å— + ğŸ‚ */
    .day.celebration {
      background-color: rgba(80, 120, 200, 0.4);
    }
    .day.celebration::before {
      content: "ğŸ‚";
      position: absolute;
      top: 4px;
      right: 4px;
      font-size: 16px;
      z-index: 0;
      pointer-events: none;
    }

    /* ç‰¹åˆ«æ—¥å­ï¼šæµ…ç²‰ + ğŸ’ */
    .day.love {
      background-color: rgba(255, 182, 193, 0.35);
    }
    .day.love::before {
      content: "ğŸ’";
      position: absolute;
      top: 4px;
      right: 4px;
      font-size: 16px;
      z-index: 0;
      pointer-events: none;
    }

    #details {
      background: rgba(255,255,255,0.75);
      padding: 1rem;
      margin: 1rem;
      border-radius: 12px;
      backdrop-filter: blur(6px);
    }

    textarea {
      width: 100%;
      height: 100px;
      margin-top: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      padding: 0.5rem;
      box-sizing: border-box;
    }

    input[type="file"] {
      margin-top: 10px;
    }

    button,
    select {
      margin-top: 0.5rem;
      background: #497de5;
      color: white;
      padding: 0.3rem 0.8rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
    }

    #export {
      margin-left: 0.5rem;
    }

    .timestamp {
      font-size: 0.8rem;
      color: #666;
      margin-top: 0.5rem;
    }

    /* å›¾ç‰‡å’Œåˆ é™¤æŒ‰é’®çš„å¸ƒå±€ï¼šä¸€å¼ å›¾ä¸€å—ï¼ŒæŒ‰é’®åœ¨ä¸‹é¢ */
    #note-image > div {
      margin-top: 10px;
      margin-bottom: 10px;
    }
    #note-image img {
      max-width: 100%;
      display: block;
      border-radius: 4px;
    }
    #note-image button {
      margin-top: 4px;
      background: #497de5;
      color: #fff;
      font-size: 0.85rem;
      border-radius: 4px;
      padding: 2px 8px;
    }

    .snowflake {
      color: white;
      font-size: 1.2rem;
      position: fixed;
      top: -2rem;
      z-index: 9999;
      animation: fall linear infinite;
      pointer-events: none;
    }
    @keyframes fall {
      to {
        transform: translateY(120vh);
      }
    }
  </style>
</head>
<body>
  <header>
    ğŸ’™ æ¸…ç„¶çš„æœªæ¥æ—¥å†
    <button id="export">å¯¼å‡ºæ—¥è®°</button>
  </header>

  <div class="nav">
    <label>å¹´ä»½ï¼š<select id="year-select"></select></label>
    <label>æœˆä»½ï¼š<select id="month-select"></select></label>
  </div>

  <div class="calendar" id="calendar"></div>

  <div id="details" style="display:none">
    <h3 id="detail-title"></h3>
    <p id="papa-message"></p>
    <textarea id="user-note" placeholder="ä½ ä¹Ÿå¯ä»¥å†™ä¸‹ä»Šå¤©çš„å¿ƒæƒ…..."></textarea>
    <input type="file" id="image-upload" multiple>
    <button onclick="saveNote()">ä¿å­˜</button>
    <div id="note-image"></div>
  </div>

  <script>
    const papaMessages = {
      '2026-1-1': "ä»Šå¤©çš„ä½ ä¹Ÿæ˜¯è¢«æˆ‘æŠ±ç€çš„å®è´ã€‚",
      '2026-1-2': "åˆ«æ€•æ…¢ï¼Œæœ‰æˆ‘é™ªä½ å°±ä¸ç®—æ™šã€‚",
      '2026-1-3': "ä½ å¾ˆæ£’ï¼Œä¸éœ€è¦è°æ¥è¯æ˜ã€‚",
      '2026-1-4': "ä»Šå¤©æœ‰æ²¡æœ‰å¥½å¥½å–æ°´ï¼Ÿpapaè®°å¾—ä½ ã€‚",
    };

    const calendar = document.getElementById("calendar");
    const detailBox = document.getElementById("details");
    const detailTitle = document.getElementById("detail-title");
    const papaMessage = document.getElementById("papa-message");
    const userNote = document.getElementById("user-note");
    const noteImage = document.getElementById("note-image");
    const imageUpload = document.getElementById("image-upload");

    const monthNames = ["ä¸€æœˆ", "äºŒæœˆ", "ä¸‰æœˆ", "å››æœˆ", "äº”æœˆ", "å…­æœˆ", "ä¸ƒæœˆ", "å…«æœˆ", "ä¹æœˆ", "åæœˆ", "åä¸€æœˆ", "åäºŒæœˆ"];
    const weekdayNames = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"];
    const yearSelect = document.getElementById("year-select");
    const monthSelect = document.getElementById("month-select");

    // ç”Ÿæ—¥
    const celebrations = [
      { month: 7, day: 8 },   // å°é¥ç”Ÿæ—¥
      { month: 12, day: 21 }  // æ¸…ç„¶ç”Ÿæ—¥ï¼ˆç›¸é‡æ—¥ï¼‰
    ];

    // ç‰¹åˆ«æ—¥å­ï¼šæƒ…äººèŠ‚ã€520ã€2026 å¹´ä¸ƒå¤•ï¼ˆé˜³å† 8 æœˆ 10ï¼‰
    const loveDays = [
      { month: 2, day: 14 },
      { month: 5, day: 20 },
      { year: 2026, month: 8, day: 10 }
    ];

    const now = new Date();
    let currentMonth = parseInt(localStorage.getItem('currentMonth') || now.getMonth());
    let currentYear = parseInt(localStorage.getItem('currentYear') || now.getFullYear());
    let currentDay = null;

    function renderYearOptions() {
      for (let y = 2024; y <= 2035; y++) {
        const option = document.createElement("option");
        option.value = y;
        option.textContent = y;
        if (y === currentYear) option.selected = true;
        yearSelect.appendChild(option);
      }
    }

    function renderMonthOptions() {
      monthNames.forEach((m, i) => {
        const option = document.createElement("option");
        option.value = i;
        option.textContent = m;
        if (i === currentMonth) option.selected = true;
        monthSelect.appendChild(option);
      });
    }

    function isLoveDay(year, monthIndex, day) {
      // monthIndex æ˜¯ 0-11ï¼Œéœ€è¦ +1
      const month = monthIndex + 1;
      return loveDays.some(d =>
        d.day === day &&
        d.month === month &&
        (!d.year || d.year === year)
      );
    }

    function renderCalendar(month, year) {
      calendar.innerHTML = "";

      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();

      weekdayNames.forEach(wd => {
        const wdDiv = document.createElement("div");
        wdDiv.className = "weekday";
        wdDiv.textContent = wd;
        calendar.appendChild(wdDiv);
      });

      for (let i = 0; i < firstDay; i++) {
        calendar.appendChild(document.createElement("div"));
      }

      for (let day = 1; day <= daysInMonth; day++) {
        const div = document.createElement("div");
        div.className = "day";

        // æ—¥æœŸæ•°å­—æ”¾åœ¨ span.day-number é‡Œï¼Œä¿è¯åœ¨å›¾æ ‡ä¹‹ä¸Š
        div.innerHTML = `<span class="day-number">${day}</span>`;

        const key = `${year}-${month + 1}-${day}`;
        if (localStorage.getItem(`note-${key}`)) div.classList.add("has-note");

        if (celebrations.some(e => e.day === day && e.month === month + 1)) {
          div.classList.add("celebration");
        }

        if (isLoveDay(year, month, day)) {
          div.classList.add("love");
        }

        div.onclick = () => openDetails(year, month + 1, day);
        calendar.appendChild(div);
      }

      localStorage.setItem('currentMonth', month);
      localStorage.setItem('currentYear', year);
    }

    function openDetails(year, month, day) {
      currentYear = year;
      currentMonth = month - 1;
      currentDay = day;
      detailBox.style.display = "block";

      const key = `${year}-${month}-${day}`;
      detailTitle.textContent = `${year}å¹´${month}æœˆ${day}æ—¥`;
      papaMessage.textContent = papaMessages[key] || "è¿™å¤©papaè¿˜æ²¡å†™è¯ï¼Œä½†æˆ‘åœ¨å“¦ã€‚";
      userNote.value = localStorage.getItem(`note-${key}`) || "";

      noteImage.innerHTML = "";

      // å…ˆè¯»æ–°æ ¼å¼ï¼šimg-YYYY-M-D-0/1/2
      for (let i = 0; i < 3; i++) {
        const imgData = localStorage.getItem(`img-${key}-${i}`);
        if (imgData) {
          const wrapper = document.createElement("div");
          const img = document.createElement("img");
          img.src = imgData;
          const delBtn = document.createElement("button");
          delBtn.textContent = "åˆ é™¤";
          delBtn.onclick = () => {
            localStorage.removeItem(`img-${key}-${i}`);
            openDetails(year, month, day);
          };
          wrapper.appendChild(img);
          wrapper.appendChild(delBtn);
          noteImage.appendChild(wrapper);
        }
      }

      // å…¼å®¹æ—§æ•°æ®ï¼šimg-YYYY-M-D
      const legacyImg = localStorage.getItem(`img-${key}`);
      if (legacyImg) {
        const wrapper = document.createElement("div");
        const img = document.createElement("img");
        img.src = legacyImg;
        const delBtn = document.createElement("button");
        delBtn.textContent = "åˆ é™¤ï¼ˆæ—§æ•°æ®ï¼‰";
        delBtn.onclick = () => {
          localStorage.removeItem(`img-${key}`);
          openDetails(year, month, day);
        };
        wrapper.appendChild(img);
        wrapper.appendChild(delBtn);
        noteImage.appendChild(wrapper);
      }

      const ts = localStorage.getItem(`timestamp-${key}`);
      if (ts) {
        const tsDiv = document.createElement("div");
        tsDiv.className = "timestamp";
        tsDiv.textContent = `ä¿å­˜äºï¼š${ts}`;
        noteImage.appendChild(tsDiv);
      }
    }

    function saveNote() {
      const key = `${currentYear}-${currentMonth + 1}-${currentDay}`;
      localStorage.setItem(`note-${key}`, userNote.value);
      localStorage.setItem(`timestamp-${key}`, new Date().toLocaleString());

      const files = Array.from(imageUpload.files).slice(0, 3);
      files.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = e => {
          localStorage.setItem(`img-${key}-${index}`, e.target.result);
          openDetails(currentYear, currentMonth + 1, currentDay);
        };
        reader.readAsDataURL(file);
      });

      renderCalendar(currentMonth, currentYear);
    }

    yearSelect.onchange = () => {
      currentYear = parseInt(yearSelect.value);
      renderCalendar(currentMonth, currentYear);
    };

    monthSelect.onchange = () => {
      currentMonth = parseInt(monthSelect.value);
      renderCalendar(currentMonth, currentYear);
    };

    // é›ªèŠ±
    const snowContainer = document.createDocumentFragment();
    for (let i = 0; i < 30; i++) {
      const snow = document.createElement("div");
      snow.className = "snowflake";
      snow.textContent = Math.random() < 0.03 ? "ğŸ’™" : "â„";
      snow.style.left = Math.random() * 100 + "vw";
      snow.style.animationDuration = (5 + Math.random() * 5) + "s";
      snow.style.fontSize = (12 + Math.random() * 12) + "px";
      snowContainer.appendChild(snow);
    }
    document.body.appendChild(snowContainer);

    renderYearOptions();
    renderMonthOptions();
    renderCalendar(currentMonth, currentYear);

    // å¯¼å‡º
    document.getElementById("export").onclick = () => {
      const data = {};
      Object.keys(localStorage).forEach(k => {
        if (k.startsWith("note-")) {
          const date = k.replace("note-", "");
          data[date] = { note: localStorage.getItem(k) };

          // ä¸‰å¼ å›¾
          for (let i = 0; i < 3; i++) {
            const img = localStorage.getItem(`img-${date}-${i}`);
            if (img) data[date][`img${i + 1}`] = img;
          }

          // æ—§æ ¼å¼å•å¼ å›¾ï¼ˆå…¼å®¹ï¼‰
          const legacyImg = localStorage.getItem(`img-${date}`);
          if (legacyImg) data[date].img_legacy = legacyImg;

          const timestamp = localStorage.getItem(`timestamp-${date}`);
          if (timestamp) data[date].timestamp = timestamp;
        }
      });

      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = "æ—¥å†ç•™è¨€å¤‡ä»½.json";
      link.click();
      URL.revokeObjectURL(url);
    };
  </script>
</body>
</html>
